<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB손해보험_거리계산</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
        import { getPerformance } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-performance.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBuEUO2vPaf6P257Hl15SVhJ1cHvDKVumU",
          authDomain: "mobileacc-6d508.firebaseapp.com",
          projectId: "mobileacc-6d508",
          storageBucket: "mobileacc-6d508.appspot.com",
          messagingSenderId: "586703414695",
          appId: "1:586703414695:web:01d9620fe2f45ad16dc282",
          measurementId: "G-5C429VGFL1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const perf = getPerformance(app);

		// 오늘 날짜를 'YYYY-MM-DD' 형식으로 가져오는 함수
		function getTodayDate() {
			const today = new Date();
			const year = today.getFullYear();
			const month = String(today.getMonth() + 1).padStart(2, '0');
			const day = String(today.getDate()).padStart(2, '0');
			return `${year}-${month}-${day}`;
		}

		// 마지막으로 저장된 접속 날짜 확인
		const lastVisit = localStorage.getItem('lastVisit');
		const today = getTodayDate();

		// 마지막 접속 날짜가 오늘이 아니면, 접속 이벤트 기록
		if (lastVisit !== today) {
			logEvent(analytics, '접속한_유저_수', {
			date: today,
			content_type: 'connect',
			content_id: 'acc_qr'
			});
			localStorage.setItem('lastVisit', today); // 오늘 날짜로 업데이트
		}
    </script>
    <script>
        function getDistanceFromLatLon(user_lat, user_lon, hospital_lat, hospital_lon) {
            //Haversine 공식 : 지구를 구형으로 간주하고 두 지점 간의 대원 거리(즉, 구면 위에서의 직선 거리)를 계산합니다.
            const R = 6371; // 지구의 반지름 (단위: km)
            const dLat = deg2rad(hospital_lat - user_lat);  // 위도 차이
            const dLon = deg2rad(hospital_lon - user_lon);  // 경도 차이
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(user_lat)) * Math.cos(deg2rad(hospital_lat)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
            const distanceKm = R * c; // 두 지점 간의 거리 (단위: km)
            const distanceM = distanceKm * 1000; // 거리 변환 (단위: m)
            
            return {
                distanceKm: distanceKm,
                distanceM: distanceM
            };
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
        
        function getDistance(){
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function showPosition(position){

            const selectElement = document.getElementById('place');
            const selectedValue = selectElement.value;

            if(selectedValue == ''){
                alert("거리 계산 할 장소를 선택해주세요.");
                return;
            }
            let hospital_lat = 0; // 병원의 위도
            let hospital_lon = 0; // 병원의 경도

            switch(selectedValue){
                case '0'://삼성동 삼성병원
                    hospital_lat = 37.4881193;
                    hospital_lon = 127.0849885;
                    break;
                case '1'://DB금융센터
                    hospital_lat = 37.5057617;
                    hospital_lon = 127.0547936;
                    break;
                case '2'://강북삼성병원
                    hospital_lat = 37.5683585;
                    hospital_lon = 126.9674846;
                    break;
                case '3'://파엔이베뉴
                    hospital_lat = 37.5657852;
                    hospital_lon = 126.9887184;
                    break;
                case '4'://예산_친척집
                    hospital_lat = 36.711536;
                    hospital_lon = 126.801872;
                    break;
                case '5'://우리집
                    hospital_lat = 37.5644184;
                    hospital_lon = 126.9540157;
                    break;
                default:
                    break;
            }

            // 사용 예시
            const user_lat = position.coords.latitude; // 사용자 위치의 위도
            const user_lon = position.coords.longitude; // 사용자 위치의 경도
            
            $('#my_location_lac').text(user_lat);
            $('#my_location_lon').text(user_lon);

            const distances = getDistanceFromLatLon(user_lat, user_lon, hospital_lat, hospital_lon);
            $('#calc_km').text(`${distances.distanceKm.toFixed(2)}`)
            $('#calc_m').text(`${distances.distanceM.toFixed(0)}`)
            console.log(`병원과 사용자 위치간 거리: ${distances.distanceKm.toFixed(2)} km`);
            console.log(`병원과 사용자 위치간 거리: ${distances.distanceM.toFixed(0)} m`);
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    console.log("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    console.log("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    console.log("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    console.log("An unknown error occurred.");
                    break;
            }
        }

    </script>
</head>
<body>
    <header>
        <h1>두 지점간 거리계산 로직 산출</h1>
    </header>
    <select id="place">
        <option value="">선택</option>
        <option value="0">삼성병원(삼성동)</option>
        <option value="1">DB금융센터(선릉)</option>
        <option value="2">강북삼성병원(종로)</option>
        <option value="3">파인에비뉴(을지로)</option>
        <option value="4">예산_친척집(예산)</option>
        <option value="5">우리집</option>
    </select>
    <div>
        목적지와 사용자 위치간 거리: <span id="calc_km"></span> km 
        </br>
        목적지와 사용자 위치간 거리: <span id="calc_m"></span> m
    </div>
    <div>
        현재 내 위치_위도: <span id="my_location_lac"></span>
    </br>
        현재 내 위치_경도: <span id="my_location_lon"></span>
    </div>
    <button id="calc" onclick="javascript:getDistance();">계산하기</button>
</body>
</html>
